<!doctype html>
<html lang='ko'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>ì»¤ë®¤ë‹ˆí‹° í™ˆ</title>
  <link rel='stylesheet' href='/styles.css'>
</head>
<body>
<header class='top'>
  <div class='wrap row'>
    <a class='logo' href='/index.html'>PARK COMMUNITY</a>
    <nav class='nav'><a href='/mypage.html'>ë§ˆì´í˜ì´ì§€</a></nav>
    <div class='spacer'></div>
    <span id='authTop' class='muted'></span>
    <button id='authBtn' class='btn'>ë¡œê·¸ì¸</button>
  </div>
</header>

<main class='wrap'>
  <div class='home-grid'>
    <section class='panel'>
      <div class='board-title-row'>
        <h3>ìµœì‹  ê²Œì‹œê¸€</h3>
        <div style='display:flex;gap:8px'>
          <button id='btnRefreshPosts' class='btn'>ìƒˆë¡œê³ ì¹¨</button>
          <button id='btnOpenWrite' class='btn primary' style='display:none'>ê¸€ì“°ê¸°</button>
        </div>
      </div>
      <table class='table'>
        <thead><tr><th>ì œëª©</th></tr></thead>
        <tbody id='homePosts'></tbody>
      </table>
    </section>

    <aside class='panel side-panel'>
      <div id='loginBox'>
        <h3>ë¡œê·¸ì¸</h3>
        <input id='liId' placeholder='ì•„ì´ë””'>
        <input id='liPw' type='password' placeholder='ë¹„ë°€ë²ˆí˜¸'>
        <button id='btnLogin' class='btn primary' style='margin-top:10px'>ë¡œê·¸ì¸</button>
        <p class='muted signup-link'>íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”? <a href='/signup.html'>íšŒì›ê°€ì…</a></p>
      </div>

      <div id='meBox' style='display:none'>
        <div class='profile-head'>
          <div id='meAvatar' class='avatar'>?</div>
          <div>
            <div id='meName' class='profile-name'>-</div>
            <div id='meRole' class='role-badge'>íšŒì›</div>
          </div>
        </div>

        <div class='profile-stats'>
          <div><span>ë‚´ ê¸€</span><b id='myPostCount'>0</b></div>
          <div><span>ì˜¤ëŠ˜ ì‘ì„±</span><b id='todayPostCount'>0</b></div>
        </div>

        <div class='profile-actions'>
          <a class='btn' href='/mypage.html'>ë§ˆì´í˜ì´ì§€</a>
          <button id='btnSideLogout' class='btn'>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </aside>
  </div>

  <section class='home-extras'>
    <div class='stats-grid'>
      <article class='panel stat-card'><div class='stat-label'>ì „ì²´ ê²Œì‹œê¸€</div><div id='sPosts' class='stat-value'>0</div></article>
      <article class='panel stat-card'><div class='stat-label'>ì „ì²´ ëŒ“ê¸€</div><div id='sComments' class='stat-value'>0</div></article>
      <article class='panel stat-card'><div class='stat-label'>ì˜¤ëŠ˜ ì‘ì„±</div><div id='sToday' class='stat-value'>0</div></article>
      <article class='panel stat-card'><div class='stat-label'>ë‚´ ê¸€</div><div id='sMine' class='stat-value'>0</div></article>
    </div>

    <div class='bottom-grid'>
      <article class='panel'><h3 style='margin:0'>ì‹¤ì‹œê°„ í™œë™</h3><div id='activityList' class='activity-list'></div></article>
      <article class='panel'><h3 style='margin:0'>ì¸ê¸° í‚¤ì›Œë“œ</h3><div id='chipWrap' class='chips'></div><div class='footer-note' style='margin-top:12px'>ê²Œì‹œíŒì„ ê¾¸ì¤€íˆ ê°±ì‹ í•´ ë‘ë©´ ì»¤ë®¤ë‹ˆí‹° ì²´ê° í’ˆì§ˆì´ í™• ì˜¬ë¼ê°€ìš”. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ìœ¼ë¡œ ìµœì‹  ë°˜ì˜ ìƒíƒœë¥¼ ìœ ì§€í•´ë³´ì„¸ìš”.</div></article>
    </div>
  </section>
</main>

<div id='writeModal' class='modal hidden'>
  <div class='modal-card'>
    <h3>ê¸€ì“°ê¸°</h3>
    <label id='noticeWrap' style='display:none;align-items:center;gap:8px;margin-top:6px'>
      <input id='isNotice' type='checkbox' style='width:auto;margin:0'> ê³µì§€ë¡œ ë“±ë¡ (ê´€ë¦¬ì)
    </label>
    <input id='pt' placeholder='ì œëª©'>
    <textarea id='pc' placeholder='ë‚´ìš©'></textarea>
    <div style='display:flex;gap:8px;margin-top:10px'>
      <button id='btnPost' class='btn primary'>ë“±ë¡</button>
      <button id='btnCloseWrite' class='btn'>ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id='detailModal' class='modal hidden'>
  <div class='modal-card detail-card'>
    <h3 id='dTitle'></h3>
    <p id='dMeta' class='muted'></p>
    <div id='dContent' class='post-content' style='font-size:18px;margin-top:12px'></div>
    <hr style='border:none;border-top:1px solid #e5e7eb;margin:16px 0'>
    <h4 style='margin:0'>ëŒ“ê¸€</h4>
    <div id='dComments' class='comment-list'></div>
    <div id='dCommentWrite' style='display:none;margin-top:10px'>
      <input id='dCi' placeholder='ëŒ“ê¸€ ì…ë ¥'>
      <button id='btnDComment' class='btn primary' style='margin-top:10px'>ë“±ë¡</button>
    </div>
    <div style='display:flex;gap:8px;justify-content:flex-end;margin-top:14px'>
      <button id='btnDDelete' class='btn' style='display:none'>ê¸€ ì‚­ì œ</button>
      <button id='btnDClose' class='btn'>ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script src='/api.js'></script>
<script>
let me = null, isAdmin = false, posts = [], selected = null;
const stop = new Set(['ì…ë‹ˆë‹¤','ì•ˆë…•í•˜ì„¸ìš”','ê·¸ë¦¬ê³ ','ì œëª©','ê³µì§€','ë°˜ê°‘ìŠµë‹ˆë‹¤']);

const commentCount = (p) => p.commentsCnt ?? p.commentCount ?? p.commentsCount ?? 0;
const fmt = (n) => Number(n || 0).toLocaleString('ko-KR');
const isNoticePost = (p) => String(p.title || '').startsWith('[ê³µì§€]');
const displayTitle = (t) => isNoticePost({ title: t }) ? String(t).replace(/^\[ê³µì§€\]\s*/, '') : t;

function renderStats() {
  const totalPosts = posts.length;
  const totalComments = posts.reduce((a, p) => a + commentCount(p), 0);
  const today = new Date().toISOString().slice(0, 10);
  const todayPosts = posts.filter(p => String(p.createdAt || '').slice(0, 10) === today).length;
  const mine = me ? posts.filter(p => p.userId === me.id).length : 0;
  sPosts.textContent = fmt(totalPosts);
  sComments.textContent = fmt(totalComments);
  sToday.textContent = fmt(todayPosts);
  sMine.textContent = fmt(mine);
  if (me) {
    myPostCount.textContent = fmt(mine);
    todayPostCount.textContent = fmt(todayPosts);
  }
}

function renderActivity() {
  const list = posts.slice(0, 6).map(p =>
    `<div class='activity-item'><span>${isNoticePost(p) ? 'ğŸ“Œ ' : ''}${displayTitle(p.title)}</span><span class='muted'>ëŒ“ê¸€ ${commentCount(p)}</span></div>`
  ).join('');
  activityList.innerHTML = list || "<div class='muted'>ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
}

function renderChips() {
  const words = (posts.map(p => displayTitle(p.title || '')).join(' ').match(/[ê°€-í£A-Za-z0-9]{2,}/g) || [])
    .map(w => w.toLowerCase()).filter(w => !stop.has(w));
  const map = {};
  for (const w of words) map[w] = (map[w] || 0) + 1;
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,12);
  chipWrap.innerHTML = top.length
    ? top.map(([w,c]) => `<span class='chip'>#${w} Â· ${c}</span>`).join('')
    : "<span class='muted'>í‚¤ì›Œë“œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</span>";
}

async function loadPosts() {
  try {
    posts = await KApi.posts();
    posts.sort((a,b)=>{
      const an = isNoticePost(a) ? 1 : 0;
      const bn = isNoticePost(b) ? 1 : 0;
      if (an !== bn) return bn - an;
      return (b.id || 0) - (a.id || 0);
    });

    homePosts.innerHTML = '';
    posts.slice(0, 30).forEach(p => {
      const tr = document.createElement('tr');
      tr.className = 'rowlink';
      const cc = commentCount(p);
      const badge = isNoticePost(p) ? "<span class='chip' style='padding:3px 8px;margin-right:6px'>ê³µì§€</span>" : '';
      tr.innerHTML = `<td class='title-cell'>${badge}${displayTitle(p.title)}${cc>0?` <span class='muted'>[${cc}]</span>`:''}</td>`;
      tr.onclick = () => location.href = `/post.html?id=${p.id}`;
      homePosts.appendChild(tr);
    });

    renderStats();
    renderActivity();
    renderChips();
  } catch {
    homePosts.innerHTML = `<tr><td class='muted'>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
  }
}

async function loadAuth() {
  try {
    me = await KApi.me();
    const perm = await KApi.mePermissions().catch(()=>({admin:false}));
    isAdmin = !!perm.admin;

    authTop.textContent = `${me.nickname||me.username} ë‹˜ ë¡œê·¸ì¸ ì¤‘`;
    authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
    authBtn.onclick = async () => { try { await KApi.logout(); location.reload(); } catch(e){ alert(e.message); } };
    btnSideLogout.onclick = async () => { try { await KApi.logout(); location.reload(); } catch(e){ alert(e.message); } };

    btnOpenWrite.style.display = 'inline-flex';
    noticeWrap.style.display = isAdmin ? 'flex' : 'none';
    loginBox.style.display = 'none';
    meBox.style.display = 'block';

    const name = me.nickname || me.username;
    meName.textContent = name;
    meAvatar.textContent = String(name).charAt(0).toUpperCase();
    meRole.textContent = isAdmin ? 'ê´€ë¦¬ì' : 'ì¼ë°˜íšŒì›';
    meRole.classList.toggle('admin', isAdmin);
  } catch {
    me = null;
    isAdmin = false;
    authTop.textContent = 'ë¹„ë¡œê·¸ì¸';
    authBtn.textContent = 'ë¡œê·¸ì¸';
    authBtn.onclick = () => location.href = '/auth.html';
    btnOpenWrite.style.display = 'none';
    noticeWrap.style.display = 'none';
    loginBox.style.display = 'block';
    meBox.style.display = 'none';
  }
}

btnLogin.onclick = async () => {
  try { await KApi.login({ username: liId.value, password: liPw.value }); location.reload(); }
  catch (e) { alert(e.message); }
};

btnRefreshPosts.onclick = loadPosts;
btnOpenWrite.onclick = () => writeModal.classList.remove('hidden');
btnCloseWrite.onclick = () => writeModal.classList.add('hidden');

btnPost.onclick = async () => {
  try {
    let title = pt.value.trim();
    if (isAdmin && isNotice.checked && !/^\[ê³µì§€\]/.test(title)) title = '[ê³µì§€] ' + title;
    await KApi.createPost({ title, content: pc.value });
    pt.value = ''; pc.value = ''; isNotice.checked = false;
    writeModal.classList.add('hidden');
    await loadPosts();
  } catch(e) { alert(e.message); }
};

writeModal.addEventListener('click', e => { if (e.target === writeModal) writeModal.classList.add('hidden'); });
btnDClose.onclick = () => detailModal.classList.add('hidden');
detailModal.addEventListener('click', e => { if (e.target === detailModal) detailModal.classList.add('hidden'); });

async function openDetail(id) {
  selected = await KApi.post(id);
  let writer = `${selected.userId}`;
  try {
    const u = await KApi.getUser(selected.userId);
    writer = u.nickname || u.username || writer;
  } catch {}

  dTitle.textContent = (isNoticePost(selected) ? 'ğŸ“Œ ' : '') + displayTitle(selected.title);
  dMeta.textContent = `ì‘ì„±ì ${writer}`;
  dContent.innerHTML = (selected.content || '').replace(/\n/g, '<br>');

  const cs = await KApi.comments(id);
  dComments.innerHTML = cs.length
    ? cs.map(c => `<div class='comment'>${c.content}</div>`).join('')
    : `<p class='muted'>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;

  if (me) {
    dCommentWrite.style.display = 'block';
    btnDDelete.style.display = (isAdmin || me.id === selected.userId) ? 'inline-flex' : 'none';
  } else {
    dCommentWrite.style.display = 'none';
    btnDDelete.style.display = 'none';
  }

  detailModal.classList.remove('hidden');
}

btnDComment.onclick = async () => {
  if (!dCi.value.trim() || !selected) return;
  try {
    await KApi.createComment(selected.id, dCi.value);
    dCi.value = '';
    await openDetail(selected.id);
    await loadPosts();
  } catch(e) { alert(e.message); }
};

btnDDelete.onclick = async () => {
  if (!selected) return;
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    await KApi.deletePost(selected.id);
    detailModal.classList.add('hidden');
    await loadPosts();
  } catch(e) { alert(e.message); }
};

loadPosts();
loadAuth();
</script>
</body>
</html>
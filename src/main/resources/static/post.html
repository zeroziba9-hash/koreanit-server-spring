<!doctype html>
<html lang='ko'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>글 상세</title>
  <link rel='stylesheet' href='/styles.css'>
</head>
<body>
  <header class='top'>
    <div class='wrap row'>
      <a class='logo' href='/index.html'>PARK COMMUNITY</a>
      <nav class='nav'>
        <a href='/index.html'>홈</a>
        <a href='/mypage.html'>마이페이지</a>
      </nav>
      <div class='spacer'></div>
      <span id='authTop' class='muted'></span>
      <button id='authBtn' class='btn'>로그인</button>
    </div>
  </header>

  <main class='wrap detail-wrap'>
    <section class='panel post-panel'>
      <h1 id='title' class='post-title'></h1>
      <p id='meta' class='muted post-meta'></p>
      <div id='content' class='post-content'></div>
      <button id='btnDel' class='btn' style='display:none'>글 삭제</button>
    </section>

    <section class='panel comment-panel'>
      <h3>댓글</h3>
      <div id='comments' class='comment-list'></div>
      <div id='commentWrite' class='comment-write' style='display:none'>
        <input id='ci' placeholder='댓글 입력'>
        <button id='btnComment' class='btn primary'>등록</button>
      </div>
    </section>
  </main>

  <script src='/api.js'></script>
  <script>
    const id = new URLSearchParams(location.search).get('id');
    let post = null, me = null, isAdmin = false;
    const userCache = new Map();

    async function userName(userId) {
      if (!userId) return '-';
      if (userCache.has(userId)) return userCache.get(userId);
      try {
        const u = await KApi.getUser(userId);
        const n = u.nickname || u.username || String(userId);
        userCache.set(userId, n);
        return n;
      } catch {
        return String(userId);
      }
    }

    async function loadAuthTop() {
      try {
        me = await KApi.me();
        const perm = await KApi.mePermissions().catch(() => ({ admin: false }));
        isAdmin = !!perm.admin;
        authTop.textContent = `${me.nickname || me.username} 님 로그인 중`;
        authBtn.textContent = '로그아웃';
        authBtn.onclick = async () => {
          try { await KApi.logout(); location.reload(); }
          catch (e) { alert(e.message); }
        };
      } catch {
        me = null;
        isAdmin = false;
        authTop.textContent = '비로그인';
        authBtn.textContent = '로그인';
        authBtn.onclick = () => location.href = '/auth.html';
      }
    }

    async function load() {
      post = await KApi.post(id);
      title.textContent = post.title;

      const writer = await userName(post.userId);
      meta.textContent = `작성자 ${writer}`;
      content.innerHTML = (post.content || '').replace(/\n/g, '<br>');

      const cs = await KApi.comments(id);
      const ids = [...new Set(cs.map(c => c.userId).filter(Boolean))];
      await Promise.all(ids.map(uid => userName(uid)));
      comments.innerHTML = cs.length
        ? cs.map(c => `<div class='comment'><span class='muted'>${userCache.get(c.userId) || c.userId}</span><br>${c.content}</div>`).join('')
        : `<p class='muted'>댓글이 없습니다.</p>`;

      if (me) {
        commentWrite.style.display = 'block';
        btnDel.style.display = (isAdmin || me.id === post.userId) ? 'inline-flex' : 'none';
      } else {
        commentWrite.style.display = 'none';
        btnDel.style.display = 'none';
      }
    }

    btnComment.onclick = async () => {
      if (!ci.value.trim()) return;
      try {
        await KApi.createComment(id, ci.value);
        ci.value = '';
        await load();
      } catch (e) { alert(e.message); }
    };

    btnDel.onclick = async () => {
      if (!confirm('삭제할까요?')) return;
      try {
        await KApi.deletePost(id);
        location.href = '/index.html';
      } catch (e) { alert(e.message); }
    };

    (async () => {
      await loadAuthTop();
      await load();
    })();
  </script>
</body>
</html>